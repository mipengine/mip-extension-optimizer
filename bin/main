#!/usr/bin/env node

'use strict';


var minimist = require('minimist');
var path = require('path');

var args = args || minimist(process.argv.slice(2));
var extensionsRoot = args._[0];

// extensionsRoot process, exit when unset
if (!extensionsRoot) {
    console.log(chalk.red('Miss Mip Extensions path!'));
    console.log('CLI Usage: mip-extension-optimise [extensions-path]');
    process.exit(1);
}
extensionsRoot = path.resolve(process.cwd(), extensionsRoot);


// traverse extensionsRoot, and do building
// TODO: trace version use git, and check which version is built, which is not.
var outputDir = path.resolve(extensionsRoot, 'dist');
var reporter = require('../lib/cli-reporter');


require('../lib/load')(extensionsRoot)
    .then(
        function (extensions) {
            var promise = Promise.resolve();

            extensions.forEach(function (extension) {
                var name = extension.info.name;
                var version = extension.info.version;

                promise = promise.then(function () {
                    reporter.info(name + '@' + version);
                    reporter.info('=========================');

                    return extension.build(outputDir, reporter)
                        .then(function () {
                            reporter.info('\n\n');
                        });
                });

            });

            return promise;
        }
    )
    .then(function () {
        reporter.info('All Done!')
    });


